<!DOCTYPE html>
<html lang="en">
  <head>
    <title>API Test</title>
    <script>
      const API_URL = 'http://localhost:8000/api';
      //const API_URL = 'https://server-f0e9-892865245121.us-central1.run.app/api';
      const baseRequest = {
        credentials: 'include',
      };
      const invalidTokens = {
        "error": "Not logged in."
      }

      let access_token = '';
      let logged_in = false;
      let this_user = 0;

      // modified from https://thewoods.blog/base64url/ since we already get a Uint8Array
      /*
      const base64url_encode = buffer => {
        return btoa(Array.from(buffer, b => String.fromCharCode(b)).join(''))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/, '');
      };
      */

      // https://stackoverflow.com/a/69058154
      const _isTokenExpired = token => Date.now() >= (JSON.parse(atob(token.split('.')[1]))).exp * 1000;

      // begin code extracted from Avocano
      const _makeAPIrequest = async (uri, init) => {
        let url = `${API_URL}/${uri}`;
        let apiError = { url: url };
        let response, data;

        try {
          response = await fetch(url, init);
          data = await response.clone().json();
        } catch (error) {
          console.error(error);

          apiError.error = error.toString();

          // Based on common reasons for failure cases, make nicer messages

          // Network Errors
          if (error instanceof TypeError && error.message == 'Failed to fetch') {
            apiError.message = `The API didn't respond. Is the API server up?`;

            // Django Errors
          } else if (
            error instanceof SyntaxError &&
            error.message.includes('is not valid JSON')
          ) {
            apiError.message = `The server returned invalid JSON. Is Django returning an error?`;
            apiError.error = `Error: "${response.statusText}"`;
            apiError.extra_error = getDjangoError(await response.text());

            // Fallback Error
          } else {
            apiError.message = `Request encountered an error: ${error.name}`;
          }
          return { apiError };
        }

        // Capture not OK responses
        if (!response?.ok) {
          apiError.message = await response?.text();
          apiError.error = `Server returned ${response?.status} - ${response?.statusText}`;
          return { apiError };
        }

        return data;
      };
      // end code extracted from Avocano

      const _apiGET = async (uri, headers) => {
        return await _makeAPIrequest(uri, {
          method: 'GET',
          headers: headers,
          ...baseRequest,
        });
      };
      const _anonGetAPI = async uri => {
        return await _apiGET(uri, {
          'Accept': 'application/json'
        });
      };

      const _apiDELETE = async (uri, headers) => {
        const token = await _anonGetAPI('csrf_token');
        headers['X-CSRFToken'] = token.csrfToken;
        return await _makeAPIrequest(uri, {
          method: 'DELETE',
          headers: headers,
          ...baseRequest,
        });
      };
      const _apiMUT = async (uri, headers, json, method) => {
        const token = await _anonGetAPI('csrf_token');
        headers['X-CSRFToken'] = token.csrfToken;
        return await _makeAPIrequest(uri, {
          method: method,
          headers: headers,
          body: JSON.stringify(json),
          ...baseRequest,
        });
      };
      const _anonPostAPI = async (uri, json) => {
        return await _apiMUT(uri, {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }, json, "POST");
      };
      // there will never be other anonymous mutable requests (fingers crossed)

      const _checkToken = async () => {
        if (access_token) {
          if (!_isTokenExpired(access_token)) return true;
        }
        if (refresh_token = localStorage.getItem("refresh_token")) {
          let try_refreshing_token = await _anonPostAPI("jwt_token/refresh/", { "refresh": refresh_token });
          if (try_refreshing_token["access"]) {
            access_token = try_refreshing_token["access"];
            return true;
          }
        }
        return false;
      };

      const getAPI = async uri => {
        if (await _checkToken()) {
          return await _apiGET(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`
          });
        }
        return _anonGetAPI(uri);
      };
      const postAPI = async (uri, json) => {
        if (await _checkToken()) {
          return await _apiMUT(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`,
            'Content-Type': 'application/json'
          }, json, "POST");
        }
        return _anonPostAPI(uri, json);
      };
      // there is no reason to ever do these other methods anonymously
      const deleteAPI = async uri => {
        if (await _checkToken()) {
          return await _apiDELETE(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`
          });
        }
        return invalidTokens;
      };
      const putAPI = async (uri, json) => {
        if (await _checkToken()) {
          return await _apiMUT(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`,
            'Content-Type': 'application/json'
          }, json, "PUT");
        }
        return invalidTokens;
      };
      const patchAPI = async (uri, json) => {
        if (await _checkToken()) {
          return await _apiMUT(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`,
            'Content-Type': 'application/json'
          }, json, "PATCH");
        }
        return invalidTokens;
      };

      const register = async (username, full_name, preferred_name, major, email, password) => {
        return await postAPI('users/',
          {
            "user": {
              "username": username,
              "email": email,
              "password": password
            },
            "full_name": full_name,
            "preferred_name": preferred_name,
            "major": major
          }
        );
      };
      const who_am_i = async () => {
        let who_am_i_response = await getAPI("who_am_i/");
        logged_in = who_am_i_response["logged_in"] ? true : false;
        this_user = who_am_i_response["snowflake_id"] ? who_am_i_response["snowflake_id"] : 0;
        return who_am_i_response;
      };
      const login = async (email, password) => {
        let token_response = await postAPI('jwt_token/',
          {
            "username": email, // sic: auth system has no convenient way to rename this field
            "password": password
          }
        );
        if (token_response["apiError"]) {
          return token_response;
        }
        access_token = token_response["access"];
        localStorage.setItem("refresh_token", token_response["refresh"]);

        //return await anonGetAPI(`email_to_user/${base64url_encode(new TextEncoder().encode(email))}`);
        return await who_am_i();
      };
      const logout = async () => {
        access_token = '';
        logged_in = false;
        this_user = 0;
        localStorage.removeItem("refresh_token");

        return await who_am_i();
      };
      const fetchUser = async snowflake => {
        return await getAPI(`users/${snowflake}/`);
      };
      const fetchPalette = async snowflake => {
        return await getAPI(`palettes/${snowflake}/`);
      };
      const fetchMentors = async snowflake => {
        return await getAPI(`mentors/${snowflake}/`);
      };
      const fetchMentees = async snowflake => {
        return await getAPI(`mentees/${snowflake}/`);
      };
      const patchUser = async diff => {
        return await patchAPI(`users/${this_user}/`, diff);
      };
      // there can't be a putUser because the validator requires submitting the credentials
      const requestMentor = async snowflake => {
        return await postAPI(`mentors/${snowflake}/`, {});
      };
      const requestMentee = async snowflake => {
        return await postAPI(`mentees/${snowflake}/`, {});
      };
      const removeMentor = async snowflake => {
        return await deleteAPI(`mentors/${snowflake}/`);
      };
      const removeMentee = async snowflake => {
        return await deleteAPI(`mentees/${snowflake}/`);
      };
      const acceptMentor = async snowflake => {
        return await patchAPI(`mentors/${snowflake}/`, {});
      };
      const acceptMentee = async snowflake => {
        return await patchAPI(`mentees/${snowflake}/`, {});
      };
      const listClubs = async () => {
        return await getAPI(`clubs/`);
      };
      const createGroup = async name => {
        return await postAPI(`groups/`, {'name': name});
      };
      const listGroups = async () => {
        return await getAPI(`groups/`);
      };
      const listMembers = async snowflake => {
        return await getAPI(`groups/${snowflake}/members/`);
      };
      const deleteGroup = async snowflake => {
        return await deleteAPI(`groups/${snowflake}/`);
      };
      const patchGroup = async (snowflake, name) => {
        return await patchAPI(`groups/${snowflake}/`, {'name': name});
      };

      const collect_optionals = (...pairs) => {
        retVal = {};
        pairs.forEach(pair => {
          if (pair[1] = pair[1].trim()) {
            retVal[pair[0]] = pair[1];
          }
        });
        return retVal;
      };

      const register_button = async () => {
        document.getElementById("register_result").innerHTML = JSON.stringify(
          await register(
            document.getElementById("register_username").value,
            document.getElementById("register_full_name").value,
            document.getElementById("register_preferred_name").value,
            document.getElementById("register_major").value,
            document.getElementById("register_email").value,
            document.getElementById("register_password").value
          )
        );
      };
      const login_button = async () => {
        document.getElementById("login_result").innerHTML = JSON.stringify(
          await login(
            document.getElementById("login_email").value,
            document.getElementById("login_password").value
          )
        );
      };
      const logout_button = async () => {
        document.getElementById("logout_result").innerHTML = JSON.stringify(await logout());
      };
      const who_am_i_button = async () => {
        document.getElementById("who_am_i_result").innerHTML = JSON.stringify(await who_am_i());
      };
      const fetchUser_button = async () => {
        document.getElementById("user_result").innerHTML = JSON.stringify(await fetchUser(document.getElementById("user_snowflake").value));
      };
      const fetchPalette_button = async () => {
        document.getElementById("user_result").innerHTML = JSON.stringify(await fetchPalette(document.getElementById("user_snowflake").value));
      };
      const fetchMentors_button = async () => {
        document.getElementById("user_result").innerHTML = JSON.stringify(await fetchMentors(document.getElementById("user_snowflake").value));
      };
      const fetchMentees_button = async () => {
        document.getElementById("user_result").innerHTML = JSON.stringify(await fetchMentees(document.getElementById("user_snowflake").value));
      };
      const patchUser_button = async () => {
        if (logged_in) {
          document.getElementById("patch_user_result").innerHTML = JSON.stringify(await patchUser(collect_optionals(
            ["full_name", document.getElementById("patch_user_full_name").value],
            ["preferred_name", document.getElementById("patch_user_preferred_name").value],
            ["major", document.getElementById("patch_user_major").value],
            ["website_url", document.getElementById("patch_user_website").value],
            ["profile_picture_url", document.getElementById("patch_user_pfp").value],
          )));
        }
        else {
          document.getElementById("patch_user_result").innerHTML = "Not logged in.";
        }
      };
      const requestMentor_button = async () => {
        if (logged_in) {
          document.getElementById("mentorship_result").innerHTML = JSON.stringify(await requestMentor(document.getElementById("mentorship_user_snowflake").value));
        }
        else {
          document.getElementById("mentorship_result").innerHTML = "Not logged in.";
        }
      };
      const requestMentee_button = async () => {
        if (logged_in) {
          document.getElementById("mentorship_result").innerHTML = JSON.stringify(await requestMentee(document.getElementById("mentorship_user_snowflake").value));
        }
        else {
          document.getElementById("mentorship_result").innerHTML = "Not logged in.";
        }
      };
      const removeMentor_button = async () => {
        if (logged_in) {
          document.getElementById("mentorship_result").innerHTML = JSON.stringify(await removeMentor(document.getElementById("mentorship_user_snowflake").value));
        }
        else {
          document.getElementById("mentorship_result").innerHTML = "Not logged in.";
        }
      };
      const removeMentee_button = async () => {
        if (logged_in) {
          document.getElementById("mentorship_result").innerHTML = JSON.stringify(await removeMentee(document.getElementById("mentorship_user_snowflake").value));
        }
        else {
          document.getElementById("mentorship_result").innerHTML = "Not logged in.";
        }
      };
      const acceptMentor_button = async () => {
        if (logged_in) {
          document.getElementById("mentorship_result").innerHTML = JSON.stringify(await acceptMentor(document.getElementById("mentorship_user_snowflake").value));
        }
        else {
          document.getElementById("mentorship_result").innerHTML = "Not logged in.";
        }
      };
      const acceptMentee_button = async () => {
        if (logged_in) {
          document.getElementById("mentorship_result").innerHTML = JSON.stringify(await acceptMentee(document.getElementById("mentorship_user_snowflake").value));
        }
        else {
          document.getElementById("mentorship_result").innerHTML = "Not logged in.";
        }
      };
      const listClubs_button = async () => {
        document.getElementById("club_list_result").innerHTML = JSON.stringify(await listClubs());
      };
      const createGroup_button = async () => {
        if (logged_in) {
          document.getElementById("group_create_result").innerHTML = JSON.stringify(await createGroup(document.getElementById("group_create_name").value));
        }
        else {
          document.getElementById("group_create_result").innerHTML = "Not logged in.";
        }
      };
      const listGroups_button = async () => {
        if (logged_in) {
          document.getElementById("group_create_result").innerHTML = JSON.stringify(await listGroups(document.getElementById("group_create_name").value));
        }
        else {
          document.getElementById("group_create_result").innerHTML = "Not logged in.";
        }
      };
      const listMembers_button = async () => {
        if (logged_in) {
          document.getElementById("group_delete_result").innerHTML = JSON.stringify(await listMembers(document.getElementById("group_delete_snowflake").value));
        }
        else {
          document.getElementById("group_delete_result").innerHTML = "Not logged in.";
        }
      };
      const deleteGroup_button = async () => {
        if (logged_in) {
          document.getElementById("group_delete_result").innerHTML = JSON.stringify(await deleteGroup(document.getElementById("group_delete_snowflake").value));
        }
        else {
          document.getElementById("group_delete_result").innerHTML = "Not logged in.";
        }
      };
      const patchGroup_button = async () => {
        if (logged_in) {
          document.getElementById("group_patch_result").innerHTML = JSON.stringify(await patchGroup(
            document.getElementById("group_patch_snowflake").value,
            document.getElementById("group_patch_name").value
          ));
        }
        else {
          document.getElementById("group_patch_result").innerHTML = "Not logged in.";
        }
      };

      who_am_i();
    </script>
  </head>
  <body>
    <h3>Register</h3>
    Username: <input id="register_username"/><br/>
    Email: <input id="register_email"/><br/>
    Password: <input type="password" id="register_password"/><br/>
    <br/>
    Full Name: <input id="register_full_name"/><br/>
    Preferred Name: <input id="register_preferred_name"/><br/>
    Major: <input id="register_major"/><br/>
    <button onclick="register_button()">Register</button><br/>
    <span id="register_result"></span><br/>

    <h3>Login</h3>
    Email: <input id="login_email"/><br/>
    Password: <input type="password" id="login_password"/><br/>
    <button onclick="login_button()">Login</button><br/>
    <span id="login_result"></span><br/>

    <h3>Logout</h3>
    <button onclick="logout_button()">Logout</button><br/>
    <span id="logout_result"></span><br/>

    <h3>Who am I?</h3>
    <button onclick="who_am_i_button()">Lookup</button><br/>
    <span id="who_am_i_result"></span><br/>

    <h3>User Lookup</h3>
    User Snowflake: <input id="user_snowflake"/><br/>
    <button onclick="fetchUser_button()">Fetch User</button>
    <button onclick="fetchPalette_button()">Fetch Palette</button>
    <button onclick="fetchMentors_button()">Fetch Mentors</button>
    <button onclick="fetchMentees_button()">Fetch Mentees</button><br/>
    <span id="user_result"></span><br/>

    <h3>User Patch</h3>
    Full Name: <input id="patch_user_full_name"/><br/>
    Preferred Name: <input id="patch_user_preferred_name"/><br/>
    Major: <input id="patch_user_major"/><br/>
    Website URL: <input id="patch_user_website"/><br/>
    Profile Picture URL: <input id="patch_user_pfp"/><br/>
    <button onclick="patchUser_button()">Patch User</button><br/>
    <span id="patch_user_result"></span><br/>

    <h3>Mentorship Request</h3>
    User Snowflake: <input id="mentorship_user_snowflake"/><br/>
    <button onclick="requestMentor_button()">Request Mentor</button>
    <button onclick="requestMentee_button()">Request Mentee</button>
    <button onclick="removeMentor_button()">Remove Mentor</button>
    <button onclick="removeMentee_button()">Remove Mentee</button>
    <button onclick="acceptMentor_button()">Accept Mentor</button>
    <button onclick="acceptMentee_button()">Accept Mentee</button><br/>
    <span id="mentorship_result"></span><br/>

    <h3>Club List</h3>
    <button onclick="listClubs_button()">List Clubs</button><br/>
    <span id="club_list_result"></span><br/>

    <h3>Create Group</h3>
    Group Name: <input id="group_create_name"/><br/>
    <button onclick="createGroup_button()">Create Group</button>
    <button onclick="listGroups_button()">List Groups</button><br/>
    <span id="group_create_result"></span><br/>

    <h3>Delete Group</h3>
    Group Snowflake: <input id="group_delete_snowflake"/><br/>
    <button onclick="listMembers_button()">List Members</button>
    <button onclick="deleteGroup_button()">Delete Group</button><br/>
    <span id="group_delete_result"></span><br/>

    <h3>Patch Group</h3>
    Group Snowflake: <input id="group_patch_snowflake"/><br/>
    Name: <input id="group_patch_name"/><br/>
    <button onclick="patchGroup_button()">Patch Group</button><br/>
    <span id="group_patch_result"></span><br/>
  </body>
</html>
