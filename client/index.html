<!DOCTYPE html>
<html lang="en">
  <head>
    <title>API Test</title>
    <script>
      const API_URL = 'http://localhost:8000/api';
      const baseRequest = {
        credentials: 'include',
      };
      const invalidTokens = {
        "error": "Not logged in."
      }

      let access_token = '';
      let logged_in = false;
      let this_user = 0;

      // modified from https://thewoods.blog/base64url/ since we already get a Uint8Array
      const base64url_encode = buffer => {
        return btoa(Array.from(buffer, b => String.fromCharCode(b)).join(''))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/, '');
      }

      // https://stackoverflow.com/a/69058154
      const _isTokenExpired = token => Date.now() >= (JSON.parse(atob(token.split('.')[1]))).exp * 1000;

      // begin code extracted from Avocano
      const _makeAPIrequest = async (uri, init) => {
        let url = `${API_URL}/${uri}`;
        let apiError = { url: url };
        let response, data;

        try {
          response = await fetch(url, init);
          data = await response.clone().json();
        } catch (error) {
          console.error(error);

          apiError.error = error.toString();

          // Based on common reasons for failure cases, make nicer messages

          // Network Errors
          if (error instanceof TypeError && error.message == 'Failed to fetch') {
            apiError.message = `The API didn't respond. Is the API server up?`;

            // Django Errors
          } else if (
            error instanceof SyntaxError &&
            error.message.includes('is not valid JSON')
          ) {
            apiError.message = `The server returned invalid JSON. Is Django returning an error?`;
            apiError.error = `Error: "${response.statusText}"`;
            apiError.extra_error = getDjangoError(await response.text());

            // Fallback Error
          } else {
            apiError.message = `Request encountered an error: ${error.name}`;
          }
          return { apiError };
        }

        // Capture not OK responses
        if (!response?.ok) {
          apiError.message = await response?.text();
          apiError.error = `Server returned ${response?.status} - ${response?.statusText}`;
          return { apiError };
        }

        return data;
      };
      // end code extracted from Avocano

      const _apiGET = async (uri, headers) => {
        return await _makeAPIrequest(uri, {
          method: 'GET',
          headers: headers,
          ...baseRequest,
        });
      };
      const _anonGetAPI = async uri => {
        return await _apiGET(uri, {
          'Accept': 'application/json'
        });
      };

      const _apiDELETE = async (uri, headers) => {
        const token = await _anonGetAPI('csrf_token');
        headers['X-CSRFToken'] = token.csrfToken;
        return await _makeAPIrequest(uri, {
          method: 'DELETE',
          headers: headers,
          ...baseRequest,
        });
      };
      const _apiMUT = async (uri, headers, json, method) => {
        const token = await _anonGetAPI('csrf_token');
        headers['X-CSRFToken'] = token.csrfToken;
        return await _makeAPIrequest(uri, {
          method: method,
          headers: headers,
          body: JSON.stringify(json),
          ...baseRequest,
        });
      };
      const _anonPostAPI = async (uri, json) => {
        return await _apiMUT(uri, {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }, json, "POST");
      };
      // there will never be other anonymous mutable requests (fingers crossed)

      const _checkToken = async () => {
        if (access_token) {
          if (!_isTokenExpired(access_token)) return true;
        }
        if (refresh_token = localStorage.getItem("refresh_token")) {
          let try_refreshing_token = await _anonPostAPI("jwt_token/refresh/", { "refresh": refresh_token });
          if (try_refreshing_token["access"]) {
            access_token = try_refreshing_token["access"];
            return true;
          }
        }
        return false;
      };

      const getAPI = async uri => {
        if (await _checkToken()) {
          return await _apiGET(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`
          });
        }
        return _anonGetAPI(uri);
      };
      const postAPI = async (uri, json) => {
        if (await _checkToken()) {
          return await _apiMUT(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`,
            'Content-Type': 'application/json'
          }, json, "POST");
        }
        return _anonPostAPI(uri, json);
      };
      // there is no reason to ever do these other methods anonymously
      const deleteAPI = async uri => {
        if (await _checkToken()) {
          return await _apiDELETE(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`
          });
        }
        return invalidTokens;
      };
      const putAPI = async (uri, json) => {
        if (await _checkToken()) {
          return await _apiPUT(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`,
            'Content-Type': 'application/json'
          }, json);
        }
        return invalidTokens;
      };
      const patchAPI = async (uri, json) => {
        if (await _checkToken()) {
          return await _apiPATCH(uri, {
            'Accept': 'application/json',
            'Authorization': `Bearer ${access_token}`,
            'Content-Type': 'application/json'
          }, json);
        }
        return invalidTokens;
      };

      const register = async (username, full_name, preferred_name, major, email, password) => {
        return await postAPI('users/',
          {
            "user": {
              "username": username,
              "email": email,
              "password": password
            },
            "full_name": full_name,
            "preferred_name": preferred_name,
            "major": major
          }
        );
      };
      const who_am_i = async () => {
        let who_am_i_response = await getAPI("who_am_i/");
        logged_in = who_am_i_response["logged_in"] ? true : false;
        this_user = who_am_i_response["snowflake_id"] ? who_am_i_response["snowflake_id"] : 0;
        return who_am_i_response;
      };
      const login = async (email, password) => {
        let token_response = await postAPI('jwt_token/',
          {
            "username": email, // sic: auth system has no convenient way to rename this field
            "password": password
          }
        );
        if (token_response["apiError"]) {
          return token_response;
        }
        access_token = token_response["access"];
        localStorage.setItem("refresh_token", token_response["refresh"]);

        //return await anonGetAPI(`email_to_user/${base64url_encode(new TextEncoder().encode(email))}`);
        return await who_am_i();
      };
      const logout = async () => {
        access_token = '';
        logged_in = false;
        this_user = 0;
        localStorage.removeItem("refresh_token");

        return await who_am_i();
      };
      const fetchUser = async snowflake => {
        return await getAPI(`users/${snowflake}/`);
      };
      const fetchPalette = async snowflake => {
        return await getAPI(`palettes/${snowflake}/`);
      };

      const register_button = async () => {
        document.getElementById("register_result").innerHTML = JSON.stringify(
          await register(
            document.getElementById("register_username").value,
            document.getElementById("register_full_name").value,
            document.getElementById("register_preferred_name").value,
            document.getElementById("register_major").value,
            document.getElementById("register_email").value,
            document.getElementById("register_password").value
          )
        );
      }
      const login_button = async () => {
        document.getElementById("login_result").innerHTML = JSON.stringify(
          await login(
            document.getElementById("login_email").value,
            document.getElementById("login_password").value
          )
        );
      }
      const logout_button = async () => {
        document.getElementById("logout_result").innerHTML = JSON.stringify(await logout());
      }
      const who_am_i_button = async () => {
        document.getElementById("who_am_i_result").innerHTML = JSON.stringify(await who_am_i());
      }
      const fetchUser_button = async () => {
        document.getElementById("user_result").innerHTML = JSON.stringify(await fetchUser(document.getElementById("user_snowflake").value));
      };
      const fetchPalette_button = async () => {
        document.getElementById("user_result").innerHTML = JSON.stringify(await fetchPalette(document.getElementById("user_snowflake").value));
      };
    </script>
  </head>
  <body>
    <h3>Register</h3>
    Username: <input id="register_username"/><br/>
    Full Name: <input id="register_full_name"/><br/>
    Preferred Name: <input id="register_preferred_name"/><br/>
    Major: <input id="register_major"/><br/>
    Email: <input id="register_email"/><br/>
    Password: <input type="password" id="register_password"/><br/>
    <button onclick="register_button()">Register</button><br/>
    <span id="register_result"></span><br/>
    <br/>
    <h3>Login</h3>
    Email: <input id="login_email"/><br/>
    Password: <input type="password" id="login_password"/><br/>
    <button onclick="login_button()">Login</button><br/>
    <span id="login_result"></span><br/>
    <br/>
    <h3>Logout</h3>
    <button onclick="logout_button()">Logout</button><br/>
    <span id="logout_result"></span><br/>
    <br/>
    <h3>Who am I?</h3>
    <button onclick="who_am_i_button()">Lookup</button><br/>
    <span id="who_am_i_result"></span><br/>
    <br/>
    <h3>User Lookup</h3>
    User Snowflake: <input id="user_snowflake"/><br/>
    <button onclick="fetchUser_button()">Fetch User</button><br/>
    <button onclick="fetchPalette_button()">Fetch Palette</button><br/>
    <span id="user_result"></span><br/>
  </body>
</html>
